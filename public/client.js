// Generated by CoffeeScript 1.3.3
(function() {
  var addMessage;

  addMessage = function(message) {
    return $('#messages').append($("<div>" + message + "</div>"));
  };

  $(function() {
    var disableFields, sendMessage, socket;
    TB.setLogLevel(TB.DEBUG);
    $('#chat-window').hide();
    socket = io.connect('/');
    sendMessage = function(event) {
      var message, messageBox;
      messageBox = $('input[name=message]');
      message = messageBox.val();
      if (message) {
        socket.emit("message_sent", messageBox.val());
        messageBox.val('');
        messageBox.focus();
      }
      return false;
    };
    disableFields = function() {
      $('#message-input').attr('disabled', true);
      return $('#send-message').toggleClass('disabled');
    };
    socket.on('got name', function(name) {
      $('#chat-window').show();
      addMessage("Welcome, " + name + "! You are based in <b>London</b>.");
      addMessage("Searching for someone to talk to...");
      return disableFields();
    });
    socket.on('found a partner', function(name, sessionId, token) {
      var session;
      $('#message-input').attr('disabled', false);
      $('#send-message').toggleClass('disabled');
      addMessage("You are now chatting to: " + name);
      console.log('ready received');
      session = TB.initSession(sessionId);
      session.addEventListener("sessionConnected", function(e) {
        return session.subscribe(e.streams[0], "subscriber");
      });
      return session.connect('16664242', token);
    });
    socket.on('message_rec', function(message, from) {
      return addMessage(from + ": " + message);
    });
    socket.on('other person disconnected', function(name) {
      addMessage(name + " disconnected");
      addMessage("Searching for someone to talk to...");
      return disableFields();
    });
    socket.on('connect', function() {
      return console.log('connected');
    });
    socket.on('initial', function(sessionId, token) {
      var session;
      console.log('initial!');
      console.log(sessionId);
      console.log(token);
      session = TB.initSession(sessionId);
      session.addEventListener("sessionConnected", function() {
        return session.publish("publisher");
      });
      session.addEventListener("streamCreated", function() {
        return socket.emit('nickname given', "Someone");
      });
      return session.connect('16664242', token);
    });
    $('.navbar').click(function() {
      return socket.disconnect();
    });
    $('#send-message').click(sendMessage);
    return $('form[name=messages]').submit(sendMessage);
  });

}).call(this);
